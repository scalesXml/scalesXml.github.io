<?xml version="1.0" encoding="utf-8"?>
			<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>scales\xml\XmlParser.scala</title>
        <script type="text/javascript" src="../../jquery-all.js"></script>
        <script type="text/javascript" src="../../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="keyword">package</span> scales.xml

<span class="keyword">import</span> org.xml.sax.<span class="delimiter">{</span>InputSource, XMLReader<span class="delimiter">}</span>
<span class="keyword">import</span> javax.xml.parsers.SAXParser
<span class="keyword">import</span> scales.utils._
<span class="keyword">import</span> java.io._

<span class="keyword">trait</span> <a title="trait XmlParserImplicits extends java.lang.Object with ScalaObject" id="12900">XmlParserImplicits</a> <span title="ScalaObject" class="delimiter">{</span>
  <span class="keyword">implicit</span> <span class="keyword">def</span> <a title="implicit scales.xml.XmlParserImplicits.streamToSource : (source: java.io.InputStream)org.xml.sax.InputSource" id="91376">streamToSource</a><span class="delimiter">(</span> <a title="java.io.InputStream" id="94626">source</a> : <span title="java.io.InputStream">InputStream</span> <span class="delimiter">)</span> = <span title="(x$1: java.io.InputStream)org.xml.sax.InputSource" class="keyword">new</span> org.xml.sax.<span title="org.xml.sax.InputSource">InputSource</span><span class="delimiter">(</span><a href="#94626" title="java.io.InputStream">source</a><span class="delimiter">)</span>
  <span class="keyword">implicit</span> <span class="keyword">def</span> <a title="implicit scales.xml.XmlParserImplicits.readerToSource : (source: java.io.Reader)org.xml.sax.InputSource" id="91377">readerToSource</a><span class="delimiter">(</span> <a title="java.io.Reader" id="94619">source</a> : <span title="java.io.Reader">Reader</span> <span class="delimiter">)</span> = <span title="(x$1: java.io.Reader)org.xml.sax.InputSource" class="keyword">new</span> org.xml.sax.<span title="org.xml.sax.InputSource">InputSource</span><span class="delimiter">(</span><a href="#94619" title="java.io.Reader">source</a><span class="delimiter">)</span>
  <span class="comment">/**
   * will call openStream.
   */</span> 
  <span class="keyword">implicit</span> <span class="keyword">def</span> <a title="implicit scales.xml.XmlParserImplicits.urlToSource : (url: java.net.URL)org.xml.sax.InputSource" id="91378">urlToSource</a><span class="delimiter">(</span> <a title="java.net.URL" id="94528">url</a> : java.net.<span title="java.net.URL">URL</span> <span class="delimiter">)</span> = <span title="(x$1: java.io.InputStream)org.xml.sax.InputSource" class="keyword">new</span> org.xml.sax.<span title="org.xml.sax.InputSource">InputSource</span><span class="delimiter">(</span><a href="#94528" title="java.net.URL">url</a>.<span title="()java.io.InputStream">openStream</span><span class="delimiter">)</span>
<span class="delimiter">}</span>

<span class="comment">/**
 * Whilst Saxon, Xerces and nu.validator support certain combinations, this is an abstraction over those needed by the readXml function
 */</span> 
<span class="keyword">trait</span> <a title="trait SaxSupport extends java.lang.Object" id="12717">SaxSupport</a> <span title="java.lang.Object" class="delimiter">{</span>
  <span class="keyword">def</span> <a title="[T &lt;: scales.xml.OptimisationToken](reader: org.xml.sax.XMLReader, handler: scales.xml.Handler[T])Unit" id="101891">setLexicalHandler</a><span class="delimiter">[</span><a title="&gt;: Nothing &lt;: scales.xml.OptimisationToken" id="101893">T</a> &lt;: OptimisationToken<span class="delimiter">]</span><span class="delimiter">(</span> <a title="org.xml.sax.XMLReader" id="102485">reader</a> : <span title="org.xml.sax.XMLReader">XMLReader</span>, <a title="scales.xml.Handler[T]" id="102486">handler</a> : <a href="#12414" title="scales.xml.Handler[T]">Handler</a><span class="delimiter">[</span>T<span class="delimiter">]</span> <span class="delimiter">)</span> : <span title="Unit">Unit</span>
  <span class="keyword">def</span> <a title="(reader: org.xml.sax.XMLReader)AnyRef" id="101894">getXmlVersion</a><span class="delimiter">(</span> <a title="org.xml.sax.XMLReader" id="102489">reader</a> : <span title="org.xml.sax.XMLReader">XMLReader</span> <span class="delimiter">)</span> : <span title="AnyRef">AnyRef</span>
<span class="delimiter">}</span>

<span class="keyword">trait</span> <a title="trait DefaultSaxSupport extends java.lang.Object with scales.xml.SaxSupport with ScalaObject" id="12213">DefaultSaxSupport</a> <span title="ScalaObject" class="keyword">extends</span> <a href="#12717" title="scales.xml.SaxSupport">SaxSupport</a> <span class="delimiter">{</span>

  <span class="keyword">def</span> <a title="[T &lt;: scales.xml.OptimisationToken](reader: org.xml.sax.XMLReader, handler: scales.xml.Handler[T])Unit" id="101896">setLexicalHandler</a><span class="delimiter">[</span><a title="&gt;: Nothing &lt;: scales.xml.OptimisationToken" id="101898">T</a> &lt;: OptimisationToken<span class="delimiter">]</span><span class="delimiter">(</span> <a title="org.xml.sax.XMLReader" id="102492">reader</a> : <span title="org.xml.sax.XMLReader">XMLReader</span>, <a title="scales.xml.Handler[T]" id="102493">handler</a> : <a href="#12414" title="scales.xml.Handler[T]">Handler</a><span class="delimiter">[</span>T<span class="delimiter">]</span> <span class="delimiter">)</span> : <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <a href="#102492" title="org.xml.sax.XMLReader">reader</a>.<span title="(x$1: java.lang.String, x$2: Any)Unit">setProperty</span><span class="delimiter">(</span><span title="java.lang.String(&quot;http://xml.org/sax/properties/lexical-handler&quot;)" class="string">&quot;http://xml.org/sax/properties/lexical-handler&quot;</span>, <a href="#102493" title="scales.xml.Handler[T]">handler</a><span class="delimiter">)</span>    
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(reader: org.xml.sax.XMLReader)AnyRef" id="101899">getXmlVersion</a><span class="delimiter">(</span> <a title="org.xml.sax.XMLReader" id="102501">reader</a> : <span title="org.xml.sax.XMLReader">XMLReader</span> <span class="delimiter">)</span> : <span title="AnyRef">AnyRef</span> =
    <a href="#102501" title="org.xml.sax.XMLReader">reader</a>.<span title="(x$1: java.lang.String)java.lang.Object">getProperty</span><span class="delimiter">(</span><span title="java.lang.String(&quot;http://xml.org/sax/properties/document-xml-version&quot;)" class="string">&quot;http://xml.org/sax/properties/document-xml-version&quot;</span><span class="delimiter">)</span>
  
<span class="delimiter">}</span>

<span class="keyword">trait</span> <a title="trait XmlParser extends java.lang.Object with ScalaObject" id="12894">XmlParser</a> <span title="ScalaObject" class="delimiter">{</span>

  <span class="keyword">import</span> <a href="ScalesXml.scala.html#12739" title="object scales.xml.ScalesXml">ScalesXml</a>.xmlCBF

  <span class="keyword">import</span> org.xml.sax.Locator
  <span class="keyword">import</span> org.xml.sax.ext.Locator2

  <span class="comment">/**
   * Use a custom parserPool to control the sax factory features 
   */</span> 
  <span class="keyword">def</span> <a title="[Token &lt;: scales.xml.OptimisationToken](source: org.xml.sax.InputSource, strategy: scales.xml.PathOptimisationStrategy[Token], parsers: scales.utils.Loaner[javax.xml.parsers.SAXParser] with scales.xml.SaxSupport)(implicit xmlVer: scales.xml.XmlVersion)scales.xml.Doc" id="15868">loadXml</a><span class="delimiter">[</span><a title="&gt;: Nothing &lt;: scales.xml.OptimisationToken" id="102512">Token</a> &lt;: OptimisationToken<span class="delimiter">]</span><span class="delimiter">(</span><a title="org.xml.sax.InputSource" id="102505">source</a>: <span title="org.xml.sax.InputSource">InputSource</span>, <a title="scales.xml.PathOptimisationStrategy[Token]" id="102510">strategy</a> : <a href="OptimisingStrategies.scala.html#12477" title="scales.xml.PathOptimisationStrategy[Token]">PathOptimisationStrategy</a><span class="delimiter">[</span>Token<span class="delimiter">]</span> = <a href="package.scala.html#15852" title="=&gt; scales.xml.PathOptimisationStrategy[scales.xml.QNameToken]">defaultPathOptimisation</a>, <a title="XmlParser extends scales.utils.Loaner[javax.xml.parsers.SAXParser] with scales.xml.SaxSupport" id="102513">parsers</a> : <a href="#102516" title="XmlParser extends scales.utils.Loaner[javax.xml.parsers.SAXParser] with scales.xml.SaxSupport">Loaner</a><span class="delimiter">[</span>SAXParser<span class="delimiter">]</span> <span class="keyword">with</span> SaxSupport= <a href="XmlFactories.scala.html#15962" title="object scales.xml.package.DefaultSAXParserFactoryPool">DefaultSAXParserFactoryPool</a>.<a href="XmlFactories.scala.html#101838" title="=&gt; java.lang.Object with scales.utils.Loaner[javax.xml.parsers.SAXParser] with scales.xml.DefaultSaxSupport">parsers</a><span class="delimiter">)</span><span class="delimiter">(</span><span class="keyword">implicit</span> <a title="scales.xml.XmlVersion" id="102508">xmlVer</a> : <a href="Namespaces.scala.html#13095" title="scales.xml.XmlVersion">XmlVersion</a><span class="delimiter">)</span>: <a href="XmlTypes.scala.html#12228" title="scales.xml.Doc">Doc</a> =
    <a href="#102513" title="XmlParser extends scales.utils.Loaner[javax.xml.parsers.SAXParser] with scales.xml.SaxSupport">parsers</a>.<a href="../utils/Resources.scala.html#89459" title="(tThunk: javax.xml.parsers.SAXParser =&gt; scales.xml.Doc)scales.xml.Doc">loan</a> <span class="delimiter">{</span>
      <a title="javax.xml.parsers.SAXParser" id="102524">parser</a> =&gt;
	<a href="#15871" title="(source: org.xml.sax.InputSource, strategy: scales.xml.PathOptimisationStrategy[Token], reader: org.xml.sax.XMLReader, saxSupport: scales.xml.SaxSupport)(implicit xmlVer: scales.xml.XmlVersion)scales.xml.Doc">readXml</a><a href="#102508" title="scales.xml.XmlVersion" class="delimiter">(</a><a href="#102505" title="org.xml.sax.InputSource">source</a>, <a href="#102510" title="scales.xml.PathOptimisationStrategy[Token]">strategy</a>, <a href="#102524" title="javax.xml.parsers.SAXParser">parser</a>.<span title="()org.xml.sax.XMLReader">getXMLReader</span><span class="delimiter">(</span><span class="delimiter">)</span>, <a href="#102513" title="XmlParser extends scales.utils.Loaner[javax.xml.parsers.SAXParser] with scales.xml.SaxSupport">parsers</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="[Token &lt;: scales.xml.OptimisationToken](source: org.xml.sax.InputSource, strategy: scales.xml.PathOptimisationStrategy[Token], reader: org.xml.sax.XMLReader, saxSupport: scales.xml.SaxSupport)(implicit xmlVer: scales.xml.XmlVersion)scales.xml.Doc" id="15871">readXml</a><span class="delimiter">[</span><a title="&gt;: Nothing &lt;: scales.xml.OptimisationToken" id="15873">Token</a> &lt;: OptimisationToken<span class="delimiter">]</span><span class="delimiter">(</span><a title="org.xml.sax.InputSource" id="102525">source</a>: <span title="org.xml.sax.InputSource">InputSource</span>, <a title="scales.xml.PathOptimisationStrategy[Token]" id="102526">strategy</a> : <a href="OptimisingStrategies.scala.html#12477" title="scales.xml.PathOptimisationStrategy[Token]">PathOptimisationStrategy</a><span class="delimiter">[</span>Token<span class="delimiter">]</span>, <a title="org.xml.sax.XMLReader" id="102527">reader</a> : <span title="org.xml.sax.XMLReader">XMLReader</span>, <a title="scales.xml.SaxSupport" id="102528">saxSupport</a> : <a href="#12717" title="scales.xml.SaxSupport">SaxSupport</a> <span class="delimiter">)</span><span class="delimiter">(</span><span class="keyword">implicit</span> <a title="scales.xml.XmlVersion" id="102529">xmlVer</a> : <a href="Namespaces.scala.html#13095" title="scales.xml.XmlVersion">XmlVersion</a><span class="delimiter">)</span>: <a href="XmlTypes.scala.html#12228" title="scales.xml.Doc">Doc</a> = <span class="delimiter">{</span>
    <span class="keyword">var</span> <a title="scales.xml.Handler[Token]" id="102547">handler</a> = <a href="#102529" title="scales.xml.Handler[Token]" class="keyword">new</a> <a href="#12414" title="scales.xml.Handler[Token]">Handler</a><span class="delimiter">[</span>Token<span class="delimiter">]</span><span class="delimiter">(</span><a href="#102526" title="scales.xml.PathOptimisationStrategy[Token]">strategy</a><span class="delimiter">)</span>
    <a href="#102528" title="scales.xml.SaxSupport">saxSupport</a>.<a href="#101891" title="[T &lt;: scales.xml.OptimisationToken](reader: org.xml.sax.XMLReader, handler: scales.xml.Handler[T])Unit">setLexicalHandler</a><span title="(reader: org.xml.sax.XMLReader, handler: scales.xml.Handler[Token])Unit" class="delimiter">[</span><a href="#15873" title="Token">Token</a><span class="delimiter">]</span><span class="delimiter">(</span><a href="#102527" title="org.xml.sax.XMLReader">reader</a>, <a href="#102547" title="scales.xml.Handler[Token]">handler</a><span class="delimiter">)</span>
    
    <a href="#102527" title="org.xml.sax.XMLReader">reader</a>.<span title="(x$1: org.xml.sax.ContentHandler)Unit">setContentHandler</span><span class="delimiter">(</span><a href="#102547" title="scales.xml.Handler[Token]">handler</a><span class="delimiter">)</span>
    <a href="#102527" title="org.xml.sax.XMLReader">reader</a>.<span title="(x$1: org.xml.sax.InputSource)Unit">parse</span><span class="delimiter">(</span><a href="#102525" title="org.xml.sax.InputSource">source</a><span class="delimiter">)</span>

    <span class="keyword">val</span> <a title="&lt;none&gt; extends Product with Serializable with scales.xml.XmlVersion" id="102548">docVersion</a> = <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="AnyRef" id="102556">f</a> = <a href="#102528" title="scales.xml.SaxSupport">saxSupport</a>.<a href="#101894" title="(reader: org.xml.sax.XMLReader)AnyRef">getXmlVersion</a><span class="delimiter">(</span><a href="#102527" title="org.xml.sax.XMLReader">reader</a><span class="delimiter">)</span>

      <span title="&lt;none&gt; extends Product with Serializable with scales.xml.XmlVersion" class="keyword">if</span> <span class="delimiter">(</span><a href="#102556" title="AnyRef">f</a> <span title="(x$1: AnyRef)Boolean">eq</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <a href="Namespaces.scala.html#12826" title="object scales.xml.Xml10">Xml10</a>
      <span class="keyword">else</span> <span class="delimiter">{</span>
	<span class="keyword">val</span> <a title="java.lang.String" id="102557">v</a> = <a href="#102556" title="AnyRef">f</a>.<span title="()java.lang.String">toString</span>
	<span title="&lt;none&gt; extends Product with Serializable with scales.xml.XmlVersion" class="keyword">if</span> <span class="delimiter">(</span><a href="#102557" title="java.lang.String">v</a> <span title="(x$1: AnyRef)Boolean">==</span> <span title="java.lang.String(&quot;1.1&quot;)" class="string">&quot;1.1&quot;</span><span class="delimiter">)</span> 
	  <a href="Namespaces.scala.html#12832" title="object scales.xml.Xml11">Xml11</a>
	<span class="keyword">else</span>
	  <a href="Namespaces.scala.html#12826" title="object scales.xml.Xml10">Xml10</a>	  
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    <a href="XmlTypes.scala.html#97489" title="(rootElem: scales.xml.package.XmlTree, prolog: scales.xml.Prolog, end: scales.xml.EndMisc)scales.xml.Doc">Doc</a><span class="delimiter">(</span><a href="#102547" title="scales.xml.Handler[Token]">handler</a>.<a href="#97343" title="=&gt; scales.xml.TreeProxies">getBuf</a>.<a href="#91996" title="=&gt; scales.xml.package.XmlTree">tree</a>, <a href="#102547" title="scales.xml.Handler[Token]">handler</a>.<a href="#97348" title="scales.xml.Prolog" id="102575">getProlog</a>.<a href="XmlTypes.scala.html#95874" title="scales.xml.package.Miscs" id="102601">copy</a><span class="delimiter">(</span> 
      decl = <a href="#102547" title="scales.xml.Handler[Token]">handler</a>.<a href="#97348" title="=&gt; scales.xml.Prolog">getProlog</a>.<a href="XmlTypes.scala.html#95367" title="scales.xml.Declaration" id="102589">decl</a>.<a href="XmlTypes.scala.html#102587" title="java.nio.charset.Charset" id="102598">copy</a><a title="scales.xml.Declaration" id="102599" class="delimiter">(</a>version = <a href="#102548" title="&lt;none&gt; extends Product with Serializable with scales.xml.XmlVersion" id="102596">docVersion</a><span class="delimiter">)</span><span class="delimiter">)</span>,
	<a href="#102547" title="scales.xml.Handler[Token]">handler</a>.<a href="#97349" title="=&gt; scales.xml.EndMisc">getEnd</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>   
  
  <span class="comment">/**
   * Use a custom parserPool to control the sax factory features 
   */</span> 
  <span class="keyword">def</span> <a title="[Token &lt;: scales.xml.OptimisationToken](source: org.xml.sax.InputSource, strategy: scales.xml.PathOptimisationStrategy[Token], parsers: scales.utils.Loaner[org.xml.sax.XMLReader] with scales.xml.SaxSupport)(implicit xmlVer: scales.xml.XmlVersion)scales.xml.Doc" id="15874">loadXmlReader</a><span class="delimiter">[</span><a title="&gt;: Nothing &lt;: scales.xml.OptimisationToken" id="102609">Token</a> &lt;: OptimisationToken<span class="delimiter">]</span><span class="delimiter">(</span><a title="org.xml.sax.InputSource" id="102602">source</a>: <span title="org.xml.sax.InputSource">InputSource</span>, <a title="scales.xml.PathOptimisationStrategy[Token]" id="102607">strategy</a> : <a href="OptimisingStrategies.scala.html#12477" title="scales.xml.PathOptimisationStrategy[Token]">PathOptimisationStrategy</a><span class="delimiter">[</span>Token<span class="delimiter">]</span> = <a href="package.scala.html#15852" title="=&gt; scales.xml.PathOptimisationStrategy[scales.xml.QNameToken]">defaultPathOptimisation</a>, <a title="XmlParser extends scales.utils.Loaner[org.xml.sax.XMLReader] with scales.xml.SaxSupport" id="102610">parsers</a> : <a href="#102613" title="XmlParser extends scales.utils.Loaner[org.xml.sax.XMLReader] with scales.xml.SaxSupport">Loaner</a><span class="delimiter">[</span>XMLReader<span class="delimiter">]</span> <span class="keyword">with</span> SaxSupport = <a href="XmlFactories.scala.html#15964" title="object scales.xml.package.DefaultXMLReaderFactoryPool">DefaultXMLReaderFactoryPool</a><span class="delimiter">)</span><span class="delimiter">(</span><span class="keyword">implicit</span> <a title="scales.xml.XmlVersion" id="102605">xmlVer</a> : <a href="Namespaces.scala.html#13095" title="scales.xml.XmlVersion">XmlVersion</a><span class="delimiter">)</span>: <a href="XmlTypes.scala.html#12228" title="scales.xml.Doc">Doc</a> =
    <a href="#102610" title="XmlParser extends scales.utils.Loaner[org.xml.sax.XMLReader] with scales.xml.SaxSupport">parsers</a>.<a href="../utils/Resources.scala.html#89459" title="(tThunk: org.xml.sax.XMLReader =&gt; scales.xml.Doc)scales.xml.Doc">loan</a> <span class="delimiter">{</span>
      <a title="org.xml.sax.XMLReader" id="102621">parser</a> =&gt;
	<a href="#15871" title="(source: org.xml.sax.InputSource, strategy: scales.xml.PathOptimisationStrategy[Token], reader: org.xml.sax.XMLReader, saxSupport: scales.xml.SaxSupport)(implicit xmlVer: scales.xml.XmlVersion)scales.xml.Doc">readXml</a><a href="#102605" title="scales.xml.XmlVersion" class="delimiter">(</a><a href="#102602" title="org.xml.sax.InputSource">source</a>, <a href="#102607" title="scales.xml.PathOptimisationStrategy[Token]">strategy</a>, <a href="#102621" title="org.xml.sax.XMLReader">parser</a>, <a href="#102610" title="XmlParser extends scales.utils.Loaner[org.xml.sax.XMLReader] with scales.xml.SaxSupport">parsers</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>

  <span class="comment">/** Elems can have any QName, attribs only prefixed or default */</span>
  <span class="keyword">def</span> <a title="[Token &lt;: scales.xml.OptimisationToken](uri: String, localName: String, qName: String, strategy: scales.xml.MemoryOptimisationStrategy[Token], token: Token)scales.xml.QName" id="15877">eqn</a><span class="delimiter">[</span><a title="&gt;: Nothing &lt;: scales.xml.OptimisationToken" id="15879">Token</a> &lt;: OptimisationToken<span class="delimiter">]</span><span class="delimiter">(</span><a title="String" id="102632">uri</a>: <span title="String">String</span>,
    <a title="String" id="102633">localName</a>: <span title="String">String</span>,
    <a title="String" id="102634">qName</a>: <span title="String">String</span>, <a title="scales.xml.MemoryOptimisationStrategy[Token]" id="102635">strategy</a> : <a href="OptimisingStrategies.scala.html#12420" title="scales.xml.MemoryOptimisationStrategy[Token]">MemoryOptimisationStrategy</a><span class="delimiter">[</span>Token<span class="delimiter">]</span>, <a title="Token" id="102636">token</a> : <a href="#15879" title="Token">Token</a><span class="delimiter">)</span>: <a href="QName.scala.html#12672" title="scales.xml.QName">QName</a> =
    <span title="scales.xml.QName" class="keyword">if</span> <span class="delimiter">(</span><a href="#102632" title="String">uri</a>.<span title="()Int">length</span><span class="delimiter">(</span><span class="delimiter">)</span> <span title="(x: Int)Boolean">==</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="comment">// can only be in qName</span>
      <a href="#102635" title="scales.xml.MemoryOptimisationStrategy[Token]">strategy</a>.<a href="OptimisingStrategies.scala.html#91188" title="(local: String, token: Token)scales.xml.NoNamespaceQName">noNamespaceQName</a><span class="delimiter">(</span><a href="#102634" title="String">qName</a>, <a href="#102636" title="Token">token</a><span class="delimiter">)</span>
    <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
      <span class="comment">// might have a prefix</span>
      <span title="scales.xml.QName" class="keyword">if</span> <span class="delimiter">(</span><a href="#102634" title="String">qName</a> <span title="(x$1: AnyRef)Boolean">==</span> <a href="#102633" title="String">localName</a><span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="comment">// no prefix</span>
	<a href="#102635" title="scales.xml.MemoryOptimisationStrategy[Token]">strategy</a>.<a href="OptimisingStrategies.scala.html#91189" title="(local: String, uri: String, token: Token)scales.xml.UnprefixedQName">unprefixedQName</a><span class="delimiter">(</span><a href="#102633" title="String">localName</a>, <a href="#102632" title="String">uri</a>, <a href="#102636" title="Token">token</a><span class="delimiter">)</span>
      <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
        <span class="comment">// break up the prefix</span>
        <span class="keyword">val</span> <a title="Array[String]" id="102657">bits</a> = <a href="#102634" title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps">qName</a>.<span title="(separator: Char)Array[String]">split</span><span class="delimiter">(</span><span title="Char(\':\')" class="char">':'</span><span class="delimiter">)</span>
	
	<a href="#102635" title="scales.xml.MemoryOptimisationStrategy[Token]">strategy</a>.<a href="OptimisingStrategies.scala.html#91190" title="(local: String, uri: String, prefix: String, token: Token)scales.xml.PrefixedQName">prefixedQName</a><span class="delimiter">(</span><a href="#102633" title="String">localName</a>, <a href="#102632" title="String">uri</a>, <a href="#102657" title="(i: Int)String">bits</a><span class="delimiter">(</span><span title="Int(0)" class="int">0</span><span class="delimiter">)</span>, <a href="#102636" title="Token">token</a><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>

  <span class="comment">/** attribs only prefixed or default */</span>
  <span class="keyword">def</span> <a title="[Token &lt;: scales.xml.OptimisationToken](uri: String, localName: String, qName: String, strategy: scales.xml.MemoryOptimisationStrategy[Token], token: Token)scales.xml.package.AttributeQName" id="15880">aqn</a><span class="delimiter">[</span><a title="&gt;: Nothing &lt;: scales.xml.OptimisationToken" id="15882">Token</a> &lt;: OptimisationToken<span class="delimiter">]</span><span class="delimiter">(</span><a title="String" id="102685">uri</a>: <span title="String">String</span>,
    <a title="String" id="102686">localName</a>: <span title="String">String</span>,
    <a title="String" id="102687">qName</a>: <span title="String">String</span>, <a title="scales.xml.MemoryOptimisationStrategy[Token]" id="102688">strategy</a> : <a href="OptimisingStrategies.scala.html#12420" title="scales.xml.MemoryOptimisationStrategy[Token]">MemoryOptimisationStrategy</a><span class="delimiter">[</span>Token<span class="delimiter">]</span>, <a title="Token" id="102689">token</a> : <a href="#15882" title="Token">Token</a><span class="delimiter">)</span>: <a href="../utils/EitherLike.scala.html#10434" title="scales.xml.package.AttributeQName">AttributeQName</a> =
    <span title="scales.xml.package.AttributeQName" class="keyword">if</span> <span class="delimiter">(</span><a href="#102685" title="String">uri</a>.<span title="()Int">length</span><span class="delimiter">(</span><span class="delimiter">)</span> <span title="(x: Int)Boolean">==</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="comment">// can only be in qName</span>
      <a href="#102688" title="scales.xml.MemoryOptimisationStrategy[Token]">strategy</a>.<a href="OptimisingStrategies.scala.html#91188" title="(local: String, token: Token)scales.xml.NoNamespaceQName">noNamespaceQName</a><span class="delimiter">(</span><a href="#102687" title="String">qName</a>, <a href="#102689" title="Token">token</a><span class="delimiter">)</span> <span class="comment">// Right</span>
    <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
      <span class="comment">// might have a prefix</span>
      <span title="scales.xml.package.AttributeQName" class="keyword">if</span> <span class="delimiter">(</span><a href="#102687" title="String">qName</a> <span title="(x$1: AnyRef)Boolean">==</span> <a href="#102686" title="String">localName</a><span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="comment">// no prefix</span>
        <a href="../utils/package.scala.html#11065" title="object scales.utils.package">scales</a>.utils.<a href="../utils/package.scala.html#15432" title="(str: String)Nothing">error</a><span class="delimiter">(</span><span title="java.lang.String(&quot;Should not have an attribute with a unprefixed namspace&quot;)" class="string">&quot;Should not have an attribute with a unprefixed namspace&quot;</span><span class="delimiter">)</span>
      <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
        <span class="comment">// break up the prefix</span>
        <span class="keyword">val</span> <a title="Array[String]" id="102707">bits</a> = <a href="#102687" title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps">qName</a>.<span title="(separator: Char)Array[String]">split</span><span class="delimiter">(</span><span title="Char(\':\')" class="char">':'</span><span class="delimiter">)</span>
        <a href="#102688" title="scales.xml.MemoryOptimisationStrategy[Token]">strategy</a>.<a href="OptimisingStrategies.scala.html#91190" title="(local: String, uri: String, prefix: String, token: Token)scales.xml.PrefixedQName">prefixedQName</a><span class="delimiter">(</span><a href="#102686" title="String">localName</a>, <a href="#102685" title="String">uri</a>,<a href="#102707" title="(i: Int)String">bits</a><span class="delimiter">(</span><span title="Int(0)" class="int">0</span><span class="delimiter">)</span>, <a href="#102689" title="Token">token</a><span class="delimiter">)</span> <span class="comment">// Left</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>

<span class="delimiter">}</span>


  <span class="keyword">import</span> org.xml.sax.Locator
  <span class="keyword">import</span> org.xml.sax.ext.Locator2

  <span class="keyword">class</span> <a title="class Handler[Token &lt;: scales.xml.OptimisationToken] extends org.xml.sax.ext.DefaultHandler2 with ScalaObject" id="12414">Handler</a><span class="delimiter">[</span><a title="&gt;: Nothing &lt;: scales.xml.OptimisationToken" id="14122">Token</a> &lt;: OptimisationToken<span class="delimiter">]</span><a href="#12414" title="ScalaObject" class="delimiter">(</a><a title="scales.xml.PathOptimisationStrategy[Token]" id="97471">strategy</a> : <a href="OptimisingStrategies.scala.html#12477" title="scales.xml.PathOptimisationStrategy[Token]">PathOptimisationStrategy</a><span class="delimiter">[</span>Token<span class="delimiter">]</span><span class="delimiter">)</span><span class="delimiter">(</span><span class="keyword">implicit</span> <span class="keyword">val</span> <a title="scales.xml.XmlVersion" id="97472">defaultVersion</a> : <a href="Namespaces.scala.html#13095" title="scales.xml.XmlVersion">XmlVersion</a><span class="delimiter">)</span> <span class="keyword">extends</span> org.xml.sax.ext.<span title="org.xml.sax.ext.DefaultHandler2">DefaultHandler2</span> <span class="delimiter">{</span>

    <span class="keyword">import</span> <a href="ScalesXml.scala.html#12739" title="object scales.xml.ScalesXml">ScalesXml</a>.xmlCBF

    <span class="keyword">import</span> scales.utils.<span class="delimiter">{</span>noPath, Path, top, ScalesUtils <span class="delimiter">}</span>
    <span class="keyword">import</span> org.xml.sax._
    <span class="keyword">import</span> scala.collection.immutable.Stack
    <span class="keyword">import</span> <a href="../utils/ScalesUtils.scala.html#11263" title="object scales.utils.ScalesUtils">ScalesUtils</a>._
<span class="comment">//    import ScalesXml.toQName // Note we aren't validating the names here anyway so we don't need to use the correct xml version, future version may double check perhaps?</span>

    <span class="keyword">private</span><span class="delimiter">[</span><span class="keyword">this</span><span class="delimiter">]</span> <span class="keyword">implicit</span> <span class="keyword">val</span> <a title="scales.xml.FromParser" id="97340">weAreInAParser</a> : <a href="XmlTypesDefaults.scala.html#12399" title="scales.xml.FromParser">FromParser</a> = <a href="XmlTypesDefaults.scala.html#15813" title="object scales.xml.package.IsFromParser">IsFromParser</a>

    <span class="keyword">private</span><span class="delimiter">[</span><span class="keyword">this</span><span class="delimiter">]</span> <span class="keyword">val</span> <a title="Token" id="97341">token</a> : <a href="#14122" title="Token">Token</a> = <a href="#97471" title="scales.xml.PathOptimisationStrategy[Token]">strategy</a>.<a href="OptimisingStrategies.scala.html#91186" title="(implicit ver: scales.xml.XmlVersion, implicit fromParser: scales.xml.FromParser)Token">createToken</a>

    <span class="comment">// only trees have kids, and we only need to keep the parent</span>
    <span class="keyword">private</span><span class="delimiter">[</span><span class="keyword">this</span><span class="delimiter">]</span> <span class="keyword">val</span> <a title="scales.xml.TreeProxies" id="97342">buf</a> = <span title="scales.xml.TreeProxies" class="keyword">new</span> <a href="#12777" title="scales.xml.TreeProxies">TreeProxies</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <span class="keyword">def</span> <a title="=&gt; scales.xml.TreeProxies" id="97343">getBuf</a> = <a href="#97342" title="scales.xml.TreeProxies">buf</a>

    <span class="keyword">private</span><span class="delimiter">[</span><span class="keyword">this</span><span class="delimiter">]</span> <span class="keyword">var</span> <a title="Boolean" id="97344">isCData</a> = <span title="Boolean(false)" class="keyword">false</span>

    <span class="comment">// declarations on this element</span>
    <span class="keyword">private</span><span class="delimiter">[</span><span class="keyword">this</span><span class="delimiter">]</span> <span class="keyword">var</span> <a title="scala.collection.immutable.Map[String,String]" id="97345">nsDeclarations</a> = <a href="XmlTypesDefaults.scala.html#15836" title="=&gt; scala.collection.immutable.Map[String,String]">emptyNamespaces</a>

    <span class="keyword">private</span><span class="delimiter">[</span><span class="keyword">this</span><span class="delimiter">]</span> <span class="keyword">var</span> <a title="scales.xml.Prolog" id="97346">prolog</a> = <a href="XmlTypes.scala.html#95791" title="(decl: scales.xml.Declaration, misc: scales.xml.package.Miscs, dtd: Option[scales.xml.DTD])scales.xml.Prolog">Prolog</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <span class="keyword">private</span><span class="delimiter">[</span><span class="keyword">this</span><span class="delimiter">]</span> <span class="keyword">var</span> <a title="scales.xml.EndMisc" id="97347">end</a> = <a href="XmlTypes.scala.html#95814" title="(misc: scales.xml.package.Miscs)scales.xml.EndMisc">EndMisc</a><span class="delimiter">(</span><span class="delimiter">)</span>

    <span class="keyword">def</span> <a title="=&gt; scales.xml.Prolog" id="97348">getProlog</a> = <a href="#97346" title="scales.xml.Prolog">prolog</a>
    <span class="keyword">def</span> <a title="=&gt; scales.xml.EndMisc" id="97349">getEnd</a> = <a href="#97347" title="scales.xml.EndMisc">end</a>

    <span class="keyword">private</span><span class="delimiter">[</span><span class="keyword">this</span><span class="delimiter">]</span> <span class="keyword">var</span> <a title="org.xml.sax.Locator" id="97350">locator</a> : <span title="org.xml.sax.Locator">Locator</span> = _
    
    <span class="comment">// used for judging PI or Comments</span>
    <span class="keyword">private</span><span class="delimiter">[</span><span class="keyword">this</span><span class="delimiter">]</span> <span class="keyword">var</span> <a title="Boolean" id="97351">inprolog</a> = <span title="Boolean(true)" class="keyword">true</span>

    <span class="keyword">def</span> <a title="(what: String)Unit" id="97352">checkit</a><span class="delimiter">(</span><a title="String" id="102756">what</a>: <span title="String">String</span><span class="delimiter">)</span> <span title="Unit" class="delimiter">{</span>
    <span class="delimiter">}</span>

    <span class="keyword">override</span> <span class="keyword">def</span> <a title="(name: String, publicId: String, systemId: String)Unit" id="97353">startDTD</a><span class="delimiter">(</span><a title="String" id="102758">name</a> : <span title="String">String</span>, <a title="String" id="102759">publicId</a> : <span title="String">String</span>, <a title="String" id="102760">systemId</a> : <span title="String">String</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#97346" title="scales.xml.Prolog">prolog</a> = <a href="#97346" title="scales.xml.Prolog" id="102762">prolog</a>.<a href="XmlTypes.scala.html#95873" title="scales.xml.Declaration" id="102771">copy</a><span class="delimiter">(</span>dtd = <span title="(x: scales.xml.DTD)Some[scales.xml.DTD]">Some</span><a title="Some[scales.xml.DTD]" id="102769" class="delimiter">(</a><a href="XmlTypes.scala.html#95898" title="(name: String, publicId: String, systemId: String)scales.xml.DTD">DTD</a><span class="delimiter">(</span><a href="#102758" title="String">name</a>, <a href="#102759" title="String">publicId</a>, <a href="#102760" title="String">systemId</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>

    <span class="keyword">override</span> <span class="keyword">def</span> <a title="(target: String, data: String)Unit" id="97354">processingInstruction</a><span class="delimiter">(</span><a title="String" id="102772">target</a> : <span title="String">String</span>, <a title="String" id="102773">data</a> : <span title="String">String</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="apply extends java.lang.Object with scales.xml.PI" id="102775">pi</a> = <a href="XmlTypes.scala.html#95385" title="(targeti: String, valuei: String)(implicit fromParser: scales.xml.FromParser)java.lang.Object with scales.xml.PI">PI</a><a href="#97340" title="scales.xml.FromParser" class="delimiter">(</a><a href="#102772" title="String">target</a>, <a href="#102773" title="String">data</a><span class="delimiter">)</span>
      <a href="#97360" title="(miscItem: scales.xml.package.Misc)Unit">addMisc</a><span class="delimiter">(</span><span title="(b: java.lang.Object with scales.xml.PI)Right[Nothing,java.lang.Object with scales.xml.PI]">Right</span><span class="delimiter">(</span><a href="#102775" title="apply extends java.lang.Object with scales.xml.PI">pi</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">}</span> 

    <span class="keyword">override</span> <span class="keyword">def</span> <a title="(prefix: String, uri: String)Unit" id="97355">startPrefixMapping</a><span class="delimiter">(</span><a title="String" id="102782">prefix</a>: <span title="String">String</span>, <a title="String" id="102783">uri</a>: <span title="String">String</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#97345" title="scala.collection.immutable.Map[String,String]">nsDeclarations</a> <span title="(kv: (String, String))scala.collection.immutable.Map[String,String]">+=</span> <span class="delimiter">(</span><a href="#102782" title="(x: String)ArrowAssoc[String]">prefix</a> <span title="(y: String)(String, String)">-&gt;</span> <a href="#102783" title="String">uri</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>

    <span class="keyword">override</span> <span class="keyword">def</span> <a title="(loc: org.xml.sax.Locator)Unit" id="97356">setDocumentLocator</a><span class="delimiter">(</span> <a title="org.xml.sax.Locator" id="102897">loc</a> : <span title="org.xml.sax.Locator">Locator</span> <span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#97350" title="org.xml.sax.Locator">locator</a> = <a href="#102897" title="org.xml.sax.Locator">loc</a>
    <span class="delimiter">}</span>

    <span class="keyword">override</span> <span class="keyword">def</span> <a title="(uri: String, localName: String, qName: String, attributes: org.xml.sax.Attributes)Unit" id="97357">startElement</a><span class="delimiter">(</span><a title="String" id="102899">uri</a>: <span title="String">String</span>,
      <a title="String" id="102900">localName</a>: <span title="String">String</span>,
      <a title="String" id="102901">qName</a>: <span title="String">String</span>,
      <a title="org.xml.sax.Attributes" id="102902">attributes</a>: org.xml.sax.<span title="org.xml.sax.Attributes">Attributes</span><span class="delimiter">)</span> <span class="delimiter">{</span>

      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#97351" title="Boolean">inprolog</a><span class="delimiter">)</span> <span class="delimiter">{</span>
	<span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#97350" title="org.xml.sax.Locator">locator</a>.<span title="[T0]=&gt; Boolean">isInstanceOf</span><span title="Boolean" class="delimiter">[</span><span title="org.xml.sax.ext.Locator2">Locator2</span><span class="delimiter">]</span><span class="delimiter">)</span> <span class="delimiter">{</span>
	  <span class="keyword">val</span> <a title="org.xml.sax.ext.Locator2" id="102937">loc2</a> = <a href="#97350" title="org.xml.sax.Locator">locator</a>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="org.xml.sax.ext.Locator2" class="delimiter">[</span><span title="org.xml.sax.ext.Locator2">Locator2</span><span class="delimiter">]</span>
	  <a href="#97346" title="scales.xml.Prolog">prolog</a> = <a href="#97346" title="scales.xml.Prolog" id="102938">prolog</a>.<a href="XmlTypes.scala.html#95874" title="scales.xml.package.Miscs" id="102948">copy</a><span class="delimiter">(</span> decl = <a href="#97346" title="scales.xml.Prolog">prolog</a>.<a href="XmlTypes.scala.html#95367" title="scales.xml.Declaration" id="102939">decl</a>.<a href="XmlTypes.scala.html#102586" title="scales.xml.XmlVersion" id="102945">copy</a><a title="scales.xml.Declaration" id="102946" class="delimiter">(</a>encoding = <span class="delimiter">(</span>
	    <a title="java.nio.charset.Charset" id="102943" class="keyword">if</a> <span class="delimiter">(</span><a href="#102937" title="org.xml.sax.ext.Locator2">loc2</a>.<span title="()java.lang.String">getEncoding</span> <span title="(x$1: AnyRef)Boolean">ne</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <span class="delimiter">{</span>
	      java.nio.charset.<span title="object java.nio.charset.Charset">Charset</span>.<span title="(x$1: java.lang.String)java.nio.charset.Charset">forName</span><span class="delimiter">(</span><a href="#102937" title="org.xml.sax.ext.Locator2">loc2</a>.<span title="()java.lang.String">getEncoding</span><span class="delimiter">)</span>
	    <span class="delimiter">}</span> <span class="keyword">else</span> <a href="../utils/package.scala.html#11065" title="object scales.utils.package">scales</a>.utils.<a href="../utils/Localisation.scala.html#15807" title="=&gt; java.nio.charset.Charset">defaultCharset</a>
	  <span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>	  
	<span class="delimiter">}</span>
      <span class="delimiter">}</span>

      <a href="#97351" title="Boolean">inprolog</a> = <span title="Boolean(false)" class="keyword">false</span>

      <span class="keyword">var</span> <a title="Int" id="102930">i</a> = <span title="Int(0)" class="int">0</span>
      <span class="keyword">val</span> <a title="Int" id="102931">length</a> = <a href="#102902" title="org.xml.sax.Attributes">attributes</a>.<span title="()Int">getLength</span>
      <span class="keyword">var</span> <a title="scales.utils.ListSet[scales.xml.Attribute]" id="102932">attribs</a> = <a href="XmlTypesDefaults.scala.html#15834" title="=&gt; scales.utils.ListSet[scales.xml.Attribute]">emptyAttributes</a>

      <span title="Unit" class="keyword">while</span> <span class="delimiter">(</span><a href="#102930" title="Int">i</a> <span title="(x: Int)Boolean">&lt;</span> <a href="#102931" title="Int">length</a><span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="scales.xml.package.AttributeQName" id="102953">qname</a> = <a href="#15880" title="(uri: String, localName: String, qName: String, strategy: scales.xml.MemoryOptimisationStrategy[Token], token: Token)scales.xml.package.AttributeQName">aqn</a><span class="delimiter">(</span><a href="#102902" title="org.xml.sax.Attributes">attributes</a>.<span title="(x$1: Int)java.lang.String">getURI</span><span class="delimiter">(</span><a href="#102930" title="Int">i</a><span class="delimiter">)</span>, <a href="#102902" title="org.xml.sax.Attributes">attributes</a>.<span title="(x$1: Int)java.lang.String">getLocalName</span><span class="delimiter">(</span><a href="#102930" title="Int">i</a><span class="delimiter">)</span>, <a href="#102902" title="org.xml.sax.Attributes">attributes</a>.<span title="(x$1: Int)java.lang.String">getQName</span><span class="delimiter">(</span><a href="#102930" title="Int">i</a><span class="delimiter">)</span>, <a href="#97471" title="scales.xml.PathOptimisationStrategy[Token]">strategy</a>, <a href="#97341" title="Token">token</a><span class="delimiter">)</span>
        <a href="#102932" title="scales.utils.ListSet[scales.xml.Attribute]">attribs</a> = <a href="#102932" title="scales.utils.ListSet[scales.xml.Attribute]">attribs</a> <a href="../utils/ListSet.scala.html#75165" title="(e: scales.xml.Attribute)scales.utils.ListSet[scales.xml.Attribute]">unsafePlus</a> 
	    <a href="#97471" title="scales.xml.PathOptimisationStrategy[Token]">strategy</a>.<a href="OptimisingStrategies.scala.html#91187" title="(qname: scales.xml.package.AttributeQName, value: String, token: Token)scales.xml.Attribute">attribute</a><span class="delimiter">(</span><a href="#102953" title="scales.xml.package.AttributeQName">qname</a>, 
			<a href="#102902" title="org.xml.sax.Attributes">attributes</a>.<span title="(x$1: Int)java.lang.String">getValue</span><span class="delimiter">(</span><a href="#102930" title="Int">i</a><span class="delimiter">)</span>, 
			<a href="#97341" title="Token">token</a><span class="delimiter">)</span>

        <a href="#102930" title="Int">i</a> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>
      <span class="delimiter">}</span>
      
      <span class="comment">// use the current nsMap</span>
      <span class="keyword">val</span> <a title="scales.xml.Elem" id="102933">elem</a> = <a href="#97471" title="scales.xml.PathOptimisationStrategy[Token]">strategy</a>.<a href="OptimisingStrategies.scala.html#91191" title="(name: scales.xml.QName, attributes: scales.xml.package.Attributes, namespaces: Map[String,String], token: Token)scales.xml.Elem">elem</a><span class="delimiter">(</span>
	  <a href="#15877" title="(uri: String, localName: String, qName: String, strategy: scales.xml.MemoryOptimisationStrategy[Token], token: Token)scales.xml.QName">eqn</a><span class="delimiter">(</span><a href="#102899" title="String">uri</a>, <a href="#102900" title="String">localName</a>, <a href="#102901" title="String">qName</a>, <a href="#97471" title="scales.xml.PathOptimisationStrategy[Token]">strategy</a>, <a href="#97341" title="Token">token</a><span class="delimiter">)</span>
	     , <a href="#102932" title="scales.utils.ListSet[scales.xml.Attribute]">attribs</a>, <a href="#97345" title="scala.collection.immutable.Map[String,String]">nsDeclarations</a>, <a href="#97341" title="Token">token</a><span class="delimiter">)</span>

      <span class="comment">// reset the map</span>
      <a href="#97345" title="scala.collection.immutable.Map[String,String]">nsDeclarations</a> = <a href="XmlTypesDefaults.scala.html#15836" title="=&gt; scala.collection.immutable.Map[String,String]">emptyNamespaces</a>

      <span class="comment">// give it a fake mutable default to work with</span>
      <a href="#97471" title="scales.xml.PathOptimisationStrategy[Token]">strategy</a>.<a href="OptimisingStrategies.scala.html#91968" title="(stack: scales.xml.TreeProxies, elem: scales.xml.Elem, token: Token)Unit">beginSubTree</a><span class="delimiter">(</span><a href="#97342" title="scales.xml.TreeProxies">buf</a>, <a href="#102933" title="scales.xml.Elem">elem</a>, <a href="#97341" title="Token">token</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>

    <span class="keyword">override</span> <span class="keyword">def</span> <a title="(uri: String, localName: String, qName: String)Unit" id="97358">endElement</a><span class="delimiter">(</span><a title="String" id="102994">uri</a>: <span title="String">String</span>,
      <a title="String" id="102995">localName</a>: <span title="String">String</span>,
      <a title="String" id="102996">qName</a>: <span title="String">String</span><span class="delimiter">)</span> <span class="delimiter">{</span>

      <span class="comment">// pop it and we are now with the correct parent</span>
      <span class="comment">// let the strategy decide what actually happens</span>
      <a href="#97471" title="scales.xml.PathOptimisationStrategy[Token]">strategy</a>.<a href="OptimisingStrategies.scala.html#91967" title="(xml: scales.xml.TreeProxies, token: Token)Unit">elementEnd</a><span class="delimiter">(</span><a href="#97342" title="scales.xml.TreeProxies">buf</a>, <a href="#97341" title="Token">token</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>

    <span class="keyword">override</span> <span class="keyword">def</span> <a title="(ch: Array[Char], offset: Int, length: Int)Unit" id="97359">comment</a><span class="delimiter">(</span><a title="Array[Char]" id="103000">ch</a>: <span title="Array[Char]">Array</span><span class="delimiter">[</span>Char<span class="delimiter">]</span>, <a title="Int" id="103001">offset</a>: <span title="Int">Int</span>, <a title="Int" id="103002">length</a>: <span title="Int">Int</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="java.lang.String" id="103004">text</a> = <span title="(x$1: Array[Char], x$2: Int, x$3: Int)java.lang.String" class="keyword">new</span> <span title="java.lang.String">String</span><span class="delimiter">(</span><a href="#103000" title="Array[Char]">ch</a>, <a href="#103001" title="Int">offset</a>, <a href="#103002" title="Int">length</a><span class="delimiter">)</span>

      <a href="#97360" title="(miscItem: scales.xml.package.Misc)Unit">addMisc</a><span class="delimiter">(</span> <span title="(a: java.lang.Object with scales.xml.Comment)Left[java.lang.Object with scales.xml.Comment,Nothing]">Left</span><span class="delimiter">(</span><a href="XmlTypes.scala.html#95991" title="(valuei: String)(implicit fromParser: scales.xml.FromParser)java.lang.Object with scales.xml.Comment">Comment</a><a href="#97340" title="scales.xml.FromParser" class="delimiter">(</a><a href="#103004" title="java.lang.String">text</a><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">)</span>      
    <span class="delimiter">}</span>

    <span class="keyword">def</span> <a title="(miscItem: scales.xml.package.Misc)Unit" id="97360">addMisc</a><span class="delimiter">(</span> <a title="scales.xml.package.Misc" id="102776">miscItem</a> : <span title="scales.xml.package.Misc">Misc</span> <span class="delimiter">)</span> <span class="delimiter">{</span>
      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#97351" title="Boolean">inprolog</a><span class="delimiter">)</span> 
	<a href="#97346" title="scales.xml.Prolog">prolog</a> = <a href="#97346" title="scales.xml.Prolog" id="103013">prolog</a>.<a href="XmlTypes.scala.html#95873" title="scales.xml.Declaration" id="103063">copy</a><span class="delimiter">(</span>misc = <a href="#97346" title="scales.xml.Prolog">prolog</a>.<a href="XmlTypes.scala.html#95369" title="=&gt; scales.xml.package.Miscs">misc</a> <a title="scales.xml.package.Miscs" id="103061">:+</a> <a href="#102776" title="scales.xml.package.Misc">miscItem</a><span class="delimiter">)</span>
      <span class="keyword">else</span> <span class="delimiter">{</span>
	<span class="comment">// need to tell if its finished the root elem or not</span>
	<span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#97342" title="scales.xml.TreeProxies">buf</a>.<a href="#91987" title="=&gt; Int">depth</a> <span title="(x: Int)Boolean">==</span> -<span title="Int(-1)" class="int">1</span><span class="delimiter">)</span>
	  <a href="#97347" title="scales.xml.EndMisc">end</a> = <a href="#97347" title="scales.xml.EndMisc">end</a>.<a href="XmlTypes.scala.html#95380" title="(misc: scales.xml.package.Miscs)scales.xml.EndMisc">copy</a><span class="delimiter">(</span> misc = <a href="#97347" title="scales.xml.EndMisc">end</a>.<a href="XmlTypes.scala.html#95377" title="=&gt; scales.xml.package.Miscs">misc</a> <span title="(elem: scales.xml.package.Misc)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[scales.xml.package.Misc],scales.xml.package.Misc,scales.xml.package.Miscs])scales.xml.package.Miscs">:+</span> <a href="#102776" title="scales.xml.package.Misc">miscItem</a><span class="delimiter">)</span>
	<span class="keyword">else</span>
	  <span class="comment">// add it like a normal child</span>
	  <a href="#97342" title="scales.xml.TreeProxies">buf</a>.<a href="#91993" title="(i: scales.xml.XmlItem)Unit">addChild</a><span class="delimiter">(</span> <a href="#102776" title="scales.xml.package.Misc">miscItem</a>.<span title="[X](fa: scales.xml.Comment =&gt; X, fb: scales.xml.PI =&gt; X)X">fold</span><span title="(fa: scales.xml.Comment =&gt; scales.xml.XmlItem, fb: scales.xml.PI =&gt; scales.xml.XmlItem)scales.xml.XmlItem" class="delimiter">[</span><a href="XmlTypes.scala.html#12876" title="scales.xml.XmlItem">XmlItem</a><span class="delimiter">]</span><span class="delimiter">(</span><a title="scales.xml.Comment" id="103124">x</a>=&gt;<a href="#103124" title="scales.xml.Comment">x</a>, <a title="scales.xml.PI" id="103126">y</a>=&gt;<a href="#103126" title="scales.xml.PI">y</a><span class="delimiter">)</span><span class="delimiter">)</span> 
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    <span class="keyword">override</span> <span class="keyword">def</span> <a title="(ch: Array[Char], offset: Int, length: Int)Unit" id="97361">characters</a><span class="delimiter">(</span><a title="Array[Char]" id="103127">ch</a>: <span title="Array[Char]">Array</span><span class="delimiter">[</span>Char<span class="delimiter">]</span>, <a title="Int" id="103128">offset</a>: <span title="Int">Int</span>, <a title="Int" id="103129">length</a>: <span title="Int">Int</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="java.lang.String" id="103131">text</a> = <span title="(x$1: Array[Char], x$2: Int, x$3: Int)java.lang.String" class="keyword">new</span> <span title="java.lang.String">String</span><span class="delimiter">(</span><a href="#103127" title="Array[Char]">ch</a>, <a href="#103128" title="Int">offset</a>, <a href="#103129" title="Int">length</a><span class="delimiter">)</span>

      <span class="keyword">val</span> <a title="scales.xml.XmlItem" id="103132">child</a>: <a href="XmlTypes.scala.html#12876" title="scales.xml.XmlItem">XmlItem</a> = <span title="scales.xml.XmlItem" class="keyword">if</span> <span class="delimiter">(</span><a href="#97344" title="Boolean">isCData</a><span class="delimiter">)</span> <a href="XmlTypes.scala.html#96682" title="(valuei: String)(implicit fromParser: scales.xml.FromParser)java.lang.Object with scales.xml.CData">CData</a><a href="#97340" title="scales.xml.FromParser" class="delimiter">(</a><a href="#103131" title="java.lang.String">text</a><span class="delimiter">)</span> <span class="keyword">else</span> <a href="XmlTypes.scala.html#96668" title="(value: String)scales.xml.Text">Text</a><span class="delimiter">(</span><a href="#103131" title="java.lang.String">text</a><span class="delimiter">)</span>

      <span class="comment">// append as child</span>
      <a href="#97342" title="scales.xml.TreeProxies">buf</a>.<a href="#91993" title="(i: scales.xml.XmlItem)Unit">addChild</a><span class="delimiter">(</span><a href="#103132" title="scales.xml.XmlItem">child</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>

    <span class="keyword">override</span> <span class="keyword">def</span> <a title="()Unit" id="97362">startCDATA</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span> <a href="#97344" title="Boolean">isCData</a> = <span title="Boolean(true)" class="keyword">true</span>; <span class="delimiter">}</span>
    <span class="keyword">override</span> <span class="keyword">def</span> <a title="()Unit" id="97363">endCDATA</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span> <a href="#97344" title="Boolean">isCData</a> = <span title="Boolean(false)" class="keyword">false</span>; <span class="delimiter">}</span>

  <span class="delimiter">}</span>


<span class="comment">// XmlBuilder, XmlChildren</span>
<span class="keyword">final</span> <span class="keyword">class</span> <a title="class TreeProxy extends java.lang.Object with ScalaObject" id="12780">TreeProxy</a><a href="#12780" title="ScalaObject" class="delimiter">(</a> <span class="keyword">private</span><span class="delimiter">[</span><span class="keyword">this</span><span class="delimiter">]</span> <span class="keyword">var</span> <a title="scales.xml.Elem" id="103151">_elem</a> : <a href="XmlTypes.scala.html#12342" title="scales.xml.Elem">Elem</a>, <span class="keyword">private</span><span class="delimiter">[</span><span class="keyword">this</span><span class="delimiter">]</span> <span class="keyword">val</span> <a title="scales.xml.package.XmlBuilder" id="103152">_builder</a> : <span title="scales.xml.package.XmlBuilder">XmlBuilder</span><span class="delimiter">)</span><span class="delimiter">{</span>
  @inline <span class="keyword">def</span> <a title="=&gt; scales.xml.Elem" id="103145">elem</a> = <a href="#103151" title="scales.xml.Elem">_elem</a>

  @inline <span class="keyword">def</span> <a title="(elem: scales.xml.Elem)Unit" id="103146">setElem</a><span class="delimiter">(</span> <a title="scales.xml.Elem" id="103156">elem</a> : <a href="XmlTypes.scala.html#12342" title="scales.xml.Elem">Elem</a> <span class="delimiter">)</span> <span class="delimiter">{</span>
    <a href="#103151" title="scales.xml.Elem">_elem</a> = <a href="#103156" title="scales.xml.Elem">elem</a>
  <span class="delimiter">}</span>

  @inline <span class="keyword">def</span> <a title="=&gt; scales.xml.package.XmlBuilder" id="103147">builder</a> = <a href="#103152" title="scales.xml.package.XmlBuilder">_builder</a>
<span class="delimiter">}</span>

<span class="keyword">import</span> scala.collection.mutable.ArrayBuffer

<span class="comment">/**
 * Mutable list that keeps the item creation to a minimum, no extra garbage here until the parse is done...
 *
 * NOTE this is effectively an internal structure, but is provided for user land performance tweaks
 */</span> 
<span class="keyword">class</span> <a title="class TreeProxies extends java.lang.Object with ScalaObject" id="12777">TreeProxies</a><a href="#12777" title="ScalaObject" class="delimiter">(</a> <span class="delimiter">)</span><span class="delimiter">{</span>
  <span class="keyword">import</span> <a href="ScalesXml.scala.html#12739" title="object scales.xml.ScalesXml">ScalesXml</a>.xmlCBF

  <span class="comment">// special case root tree</span>
  <span class="keyword">var</span> <a title="scales.xml.package.XmlTree" id="91979">rootTree</a> : <a href="../utils/Trees.scala.html#11328" title="scales.xml.package.XmlTree">XmlTree</a> = _
  
  <span class="keyword">private</span><span class="delimiter">[</span><span class="keyword">this</span><span class="delimiter">]</span> <span class="keyword">var</span> <a title="Int" id="91981">_depth</a> : <span title="Int">Int</span> = -<span title="Int(-1)" class="int">1</span>

  <span class="keyword">private</span><span class="delimiter">[</span><span class="keyword">this</span><span class="delimiter">]</span> <span class="keyword">var</span> <a title="Array[scales.xml.TreeProxy]" id="91982">_proxies</a> : <span title="Array[scales.xml.TreeProxy]">Array</span><span class="delimiter">[</span>TreeProxy<span class="delimiter">]</span> = <span title="object Array">Array</span>.<span title="[T](n1: Int)(implicit evidence$3: scala.reflect.ClassManifest[T])Array[T]">ofDim</span><span title="(n1: Int)(implicit evidence$3: scala.reflect.ClassManifest[scales.xml.TreeProxy])Array[scales.xml.TreeProxy]" class="delimiter">[</span><a href="#12780" title="scales.xml.TreeProxy">TreeProxy</a><span class="delimiter">]</span><span title="(clazz: java.lang.Class[_])scala.reflect.ClassManifest[scales.xml.TreeProxy]" class="delimiter">(</span><span title="Int(50)" class="int">50</span><span class="delimiter">)</span>

  <span class="comment">// current max size in the proxies (_proxies.length could be far larger)</span>
  <span class="keyword">private</span><span class="delimiter">[</span><span class="keyword">this</span><span class="delimiter">]</span> <span class="keyword">var</span> <a title="Int" id="91983">_size</a> = <span title="Int(0)" class="int">0</span>

  <span class="keyword">private</span><span class="delimiter">[</span><span class="keyword">this</span><span class="delimiter">]</span> <span class="keyword">var</span> <a title="scales.xml.TreeProxy" id="91984">_current</a> : <a href="#12780" title="scales.xml.TreeProxy">TreeProxy</a> = _

<span class="comment">/*
 * interface for TreeOptimisations below, don't penalise normal parsing
 */</span> 
  <span class="keyword">def</span> <a title="=&gt; scales.xml.TreeProxy" id="91985">current</a> = <a href="#91984" title="scales.xml.TreeProxy">_current</a>
  <span class="keyword">def</span> <a title="(tp: scales.xml.TreeProxy)Unit" id="91986">current_=</a><span class="delimiter">(</span> <a title="scales.xml.TreeProxy" id="103183">tp</a> : <a href="#12780" title="scales.xml.TreeProxy">TreeProxy</a> <span class="delimiter">)</span> <span class="delimiter">{</span>
    <a href="#91984" title="scales.xml.TreeProxy">_current</a> = <a href="#103183" title="scales.xml.TreeProxy">tp</a> 
  <span class="delimiter">}</span>
  <span class="keyword">def</span> <a title="=&gt; Int" id="91987">depth</a> = <a href="#91981" title="Int">_depth</a>
  <span class="keyword">def</span> <a title="(newDepth: Int)Unit" id="91988">depth_=</a> <span class="delimiter">(</span> <a title="Int" id="103185">newDepth</a> : <span title="Int">Int</span> <span class="delimiter">)</span> <span class="delimiter">{</span> <a href="#91981" title="Int">_depth</a> = <a href="#103185" title="Int">newDepth</a> <span class="delimiter">}</span>
  <span class="keyword">def</span> <a title="(depth: Int)scales.xml.TreeProxy" id="91989">proxy</a><span class="delimiter">(</span> <a title="Int" id="103187">depth</a> : <span title="Int">Int</span> <span class="delimiter">)</span> = <a href="#91982" title="(i: Int)scales.xml.TreeProxy">_proxies</a><span class="delimiter">(</span> <a href="#103187" title="Int">depth</a> <span class="delimiter">)</span>

  <span class="comment">/**
   * Strips a path from the current position to the top of tree.  The
   * existing cached trees are then effectively re-created without the current position (one depth less)
   */</span> 
  <span class="keyword">def</span> <a title="()scales.xml.package.XmlPath" id="91990">proxyPath</a><span class="delimiter">(</span><span class="delimiter">)</span> : <a href="../utils/Paths.scala.html#11076" title="scales.xml.package.XmlPath">XmlPath</a> = <span class="delimiter">{</span>
    <span class="keyword">var</span> <a title="Int" id="103190">d</a> = <a href="#91981" title="Int">_depth</a>
    <span class="keyword">val</span> <a title="scales.xml.TreeProxy" id="103191">l</a> = <a href="#91984" title="scales.xml.TreeProxy">_current</a>

    <span class="keyword">val</span> <a title="scales.xml.Elem" id="103192">te</a> = <a href="#103191" title="scales.xml.TreeProxy">l</a>.<a href="#103145" title="=&gt; scales.xml.Elem">elem</a>
    <span class="keyword">val</span> <a title="scales.xml.package.XmlChildren" id="103193">tcc</a> = <a href="#103191" title="scales.xml.TreeProxy">l</a>.<a href="#103147" title="=&gt; scales.xml.package.XmlBuilder">builder</a>.<span title="()scales.xml.package.XmlChildren">result</span>
     
    <span class="keyword">var</span> <a title="Array[scales.xml.Elem]" id="103194">elems</a> = <span title="object Array">Array</span>.<span title="[T](n1: Int)(implicit evidence$3: scala.reflect.ClassManifest[T])Array[T]">ofDim</span><span title="(n1: Int)(implicit evidence$3: scala.reflect.ClassManifest[scales.xml.Elem])Array[scales.xml.Elem]" class="delimiter">[</span><a href="XmlTypes.scala.html#12342" title="scales.xml.Elem">Elem</a><span class="delimiter">]</span><span title="(clazz: java.lang.Class[_])scala.reflect.ClassManifest[scales.xml.Elem]" class="delimiter">(</span><span title="Int" class="keyword">if</span> <span class="delimiter">(</span><a href="#103190" title="Int">d</a> <span title="(x: Int)Boolean">&lt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span title="Int(0)" class="int">0</span> <span class="keyword">else</span> <a href="#103190" title="Int">d</a><span class="delimiter">)</span>
    <span title="Unit" class="keyword">while</span><span class="delimiter">(</span> <a href="#103190" title="Int">d</a> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(0)" class="int">0</span> <span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#103190" title="Int">d</a> <span title="(x: Int)Int">-=</span> <span title="Int(1)" class="int">1</span>

      <a href="#103194" title="(i: Int, x: scales.xml.Elem)Unit">elems</a><span class="delimiter">(</span><a href="#103190" title="Int">d</a><span class="delimiter">)</span> = <a href="#91982" title="(i: Int)scales.xml.TreeProxy">_proxies</a><span class="delimiter">(</span><a href="#103190" title="Int">d</a><span class="delimiter">)</span>.<a href="#103145" title="=&gt; scales.xml.Elem">elem</a>
    <span class="delimiter">}</span>

    <a href="#91992" title="()scales.xml.TreeProxies">reuse</a>

    <span class="keyword">var</span> <a title="scales.utils.Path[scales.xml.XmlItem,scales.xml.Elem,scales.xml.package.XCC]" id="103195">p</a> = <a href="XmlTypesDefaults.scala.html#15844" title="=&gt; scales.utils.Path[scales.xml.XmlItem,scales.xml.Elem,scales.xml.package.XCC]">noXmlPath</a>

    <span class="comment">// add them back</span>
    <a href="#103190" title="Int">d</a> = <span title="Int(0)" class="int">0</span>
    <span title="Unit" class="keyword">while</span><span class="delimiter">(</span> <a href="#103190" title="Int">d</a> <span title="(x: Int)Boolean">&lt;</span> <a href="#103194" title="Array[scales.xml.Elem]">elems</a>.<span title="=&gt; Int">length</span> <span class="delimiter">)</span><span class="delimiter">{</span>
      <a href="#91995" title="(elem: scales.xml.Elem, builder: =&gt; scales.xml.package.XmlBuilder)Unit">beginSub</a><span class="delimiter">(</span><a href="#103194" title="(i: Int)scales.xml.Elem">elems</a><span class="delimiter">(</span><a href="#103190" title="Int">d</a><span class="delimiter">)</span>, <a href="XmlTypesDefaults.scala.html#15823" title="()scales.xml.package.XmlBuilder">XmlBuilder</a><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="comment">// add child to path</span>
      <a href="#103195" title="scales.utils.Path[scales.xml.XmlItem,scales.xml.Elem,scales.xml.package.XCC]">p</a> = <a href="XmlTypesDefaults.scala.html#15848" title="(path: scales.xml.package.XmlPath, elem: scales.xml.Elem, dchildren: scales.xml.package.XmlChildren)scales.utils.Path[scales.xml.XmlItem,scales.xml.Elem,scales.xml.package.XCC]">addAndFocus</a><span class="delimiter">(</span><a href="#103195" title="scales.utils.Path[scales.xml.XmlItem,scales.xml.Elem,scales.xml.package.XCC]">p</a>, <a href="#103194" title="(i: Int)scales.xml.Elem">elems</a><span class="delimiter">(</span><a href="#103190" title="Int">d</a><span class="delimiter">)</span><span class="delimiter">)</span>
      <a href="#103190" title="Int">d</a> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>
    <span class="delimiter">}</span>
    <a href="#103195" title="scales.utils.Path[scales.xml.XmlItem,scales.xml.Elem,scales.xml.package.XCC]">p</a> = <a href="XmlTypesDefaults.scala.html#15848" title="(path: scales.xml.package.XmlPath, elem: scales.xml.Elem, dchildren: scales.xml.package.XmlChildren)scales.utils.Path[scales.xml.XmlItem,scales.xml.Elem,scales.xml.package.XCC]">addAndFocus</a><span class="delimiter">(</span><a href="#103195" title="scales.utils.Path[scales.xml.XmlItem,scales.xml.Elem,scales.xml.package.XCC]">p</a>, <a href="#103192" title="scales.xml.Elem">te</a>, <a href="#103193" title="scales.xml.package.XmlChildren">tcc</a><span class="delimiter">)</span>
    
    <a href="#103195" title="scales.utils.Path[scales.xml.XmlItem,scales.xml.Elem,scales.xml.package.XCC]">p</a>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Pushes up the tree discarding the last, if its the top it &quot;resets&quot; the tree
   * Note unlike Paths, there is only the notion of last child on the parent depth.
   */</span>
  <span class="keyword">def</span> <a title="()scales.xml.TreeProxies" id="91991">proxyRemoveAndUp</a><span class="delimiter">(</span><span class="delimiter">)</span> : <a href="#12777" title="scales.xml.TreeProxies">TreeProxies</a> = <span class="delimiter">{</span>
    
    <span class="keyword">val</span> <a title="Int" id="103237">nd</a> = <a href="#91981" title="Int">_depth</a> <span title="(x: Int)Int">-</span> <span title="Int(1)" class="int">1</span>

    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#91981" title="Int">_depth</a> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#91984" title="scales.xml.TreeProxy">_current</a> = <a href="#91982" title="(i: Int)scales.xml.TreeProxy">_proxies</a><span class="delimiter">(</span> <a href="#103237" title="Int">nd</a> <span class="delimiter">)</span>
      <span class="comment">// scrap the last</span>
      <span class="comment">//val r = _current.builder.result</span>
      <a href="#91984" title="scales.xml.TreeProxy">_current</a>.<a href="#103147" title="=&gt; scales.xml.package.XmlBuilder">builder</a>.<span title="()Unit">clear</span><span class="delimiter">(</span><span class="delimiter">)</span>
    <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
      <span class="comment">// end of doc</span>
      <a href="#91979" title="(x$1: scales.xml.package.XmlTree)Unit">rootTree</a> = <span title="Null(null)" class="keyword">null</span>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="scales.xml.package.XmlTree" class="delimiter">[</span><a href="../utils/Trees.scala.html#11328" title="scales.xml.package.XmlTree">XmlTree</a><span class="delimiter">]</span>
      <a href="#91984" title="scales.xml.TreeProxy">_current</a> = <span title="Null(null)" class="keyword">null</span>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="scales.xml.TreeProxy" class="delimiter">[</span><a href="#12780" title="scales.xml.TreeProxy">TreeProxy</a><span class="delimiter">]</span>
    <span class="delimiter">}</span>
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#103237" title="Int">nd</a> <span title="(x: Int)Boolean">&gt;</span> -<span title="Int(-2)" class="int">2</span><span class="delimiter">)</span>
      <a href="#91981" title="Int">_depth</a> = <a href="#103237" title="Int">nd</a>
    <span class="keyword">else</span>
      <a href="#91981" title="Int">_depth</a> = -<span title="Int(-1)" class="int">1</span>
    
    <a href="#12777" title="scales.xml.TreeProxies" class="keyword">this</a>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Keeps the same _proxies array but resets the rest.  The old proxies is
   * no longer usable.
   * WARN - as per class docs this is effectively an internal structure caveat empor
   */</span> 
  <span class="keyword">def</span> <a title="()scales.xml.TreeProxies" id="91992">reuse</a><span class="delimiter">(</span><span class="delimiter">)</span> : <a href="#12777" title="scales.xml.TreeProxies">TreeProxies</a> = <span class="delimiter">{</span>
    <span class="comment">// size is not redone so we keep builders around</span>
    <a href="#91981" title="Int">_depth</a> = -<span title="Int(-1)" class="int">1</span>
    <a href="#91979" title="(x$1: scales.xml.package.XmlTree)Unit">rootTree</a> = <span title="Null(null)" class="keyword">null</span>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="scales.xml.package.XmlTree" class="delimiter">[</span><a href="../utils/Trees.scala.html#11328" title="scales.xml.package.XmlTree">XmlTree</a><span class="delimiter">]</span>
    <a href="#91984" title="scales.xml.TreeProxy">_current</a> = <span title="Null(null)" class="keyword">null</span>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="scales.xml.TreeProxy" class="delimiter">[</span><a href="#12780" title="scales.xml.TreeProxy">TreeProxy</a><span class="delimiter">]</span>
    <a href="#12777" title="scales.xml.TreeProxies" class="keyword">this</a>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(i: scales.xml.XmlItem)Unit" id="91993">addChild</a><span class="delimiter">(</span> <a title="scales.xml.XmlItem" id="95241">i</a> : <a href="XmlTypes.scala.html#12876" title="scales.xml.XmlItem">XmlItem</a> <span class="delimiter">)</span> <span class="delimiter">{</span>
    <a href="#91984" title="scales.xml.TreeProxy">_current</a>.<a href="#103147" title="=&gt; scales.xml.package.XmlBuilder">builder</a>.<span title="(elem: scales.utils.EitherLike[scales.xml.XmlItem,scales.utils.Tree[scales.xml.XmlItem,scales.xml.Elem,[T]scales.utils.ImmutableArrayProxy[T]]])scala.collection.mutable.Builder[scales.xml.package.ItemOrElem,scales.xml.package.XmlChildren]">+=</span><span title="Unit" class="delimiter">(</span><a href="#95241" title="scales.xml.XmlItem">i</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="()Unit" id="91994">elementEnd</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="scales.xml.TreeProxy" id="103273">l</a> = <a href="#91984" title="scales.xml.TreeProxy">_current</a>

    <span class="keyword">val</span> <a title="scales.utils.Tree[scales.xml.XmlItem,scales.xml.Elem,scales.xml.package.XCC]" id="103274">newTree</a> = <a href="../utils/Trees.scala.html#83381" title="(isection: scales.xml.Elem, ichildren: scales.xml.package.XCC[scales.utils.package.ItemOrTree[scales.xml.XmlItem,scales.xml.Elem,scales.xml.package.XCC]])scales.utils.Tree[scales.xml.XmlItem,scales.xml.Elem,scales.xml.package.XCC]">Tree</a><span class="delimiter">(</span><a href="#103273" title="scales.xml.TreeProxy">l</a>.<a href="#103145" title="=&gt; scales.xml.Elem">elem</a>, <a href="#103273" title="scales.xml.TreeProxy">l</a>.<a href="#103147" title="=&gt; scales.xml.package.XmlBuilder">builder</a>.<span title="()scales.xml.package.XmlChildren">result</span><span class="delimiter">)</span>
    
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#91981" title="Int">_depth</a> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#91981" title="Int">_depth</a> <span title="(x: Int)Int">-=</span> <span title="Int(1)" class="int">1</span>
      <a href="#91984" title="scales.xml.TreeProxy">_current</a> = <a href="#91982" title="(i: Int)scales.xml.TreeProxy">_proxies</a><span class="delimiter">(</span> <a href="#91981" title="Int">_depth</a> <span class="delimiter">)</span>
      <a href="#91984" title="scales.xml.TreeProxy">_current</a>.<a href="#103147" title="=&gt; scales.xml.package.XmlBuilder">builder</a>.<span title="(elem: scales.utils.EitherLike[scales.xml.XmlItem,scales.utils.Tree[scales.xml.XmlItem,scales.xml.Elem,[T]scales.utils.ImmutableArrayProxy[T]]])scala.collection.mutable.Builder[scales.xml.package.ItemOrElem,scales.xml.package.XmlChildren]">+=</span><span title="Unit" class="delimiter">(</span><a href="#103274" title="scales.utils.Tree[scales.xml.XmlItem,scales.xml.Elem,scales.xml.package.XCC]">newTree</a><span class="delimiter">)</span>
    <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
      <span class="comment">// end of doc</span>
      <a href="#91979" title="(x$1: scales.xml.package.XmlTree)Unit">rootTree</a> = <a href="#103274" title="scales.utils.Tree[scales.xml.XmlItem,scales.xml.Elem,scales.xml.package.XCC]">newTree</a>
      <a href="#91981" title="Int">_depth</a> <span title="(x: Int)Int">-=</span> <span title="Int(1)" class="int">1</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(elem: scales.xml.Elem, builder: =&gt; scales.xml.package.XmlBuilder)Unit" id="91995">beginSub</a><span class="delimiter">(</span> <a title="scales.xml.Elem" id="92002">elem</a> : <a href="XmlTypes.scala.html#12342" title="scales.xml.Elem">Elem</a>, <a title="=&gt; scales.xml.package.XmlBuilder" id="92003">builder</a> : =&gt; XmlBuilder<span class="delimiter">)</span> <span class="delimiter">{</span>
    <a href="#91981" title="Int">_depth</a> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>
    
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#91981" title="Int">_depth</a> <span title="(x: Int)Boolean">==</span> <a href="#91982" title="Array[scales.xml.TreeProxy]">_proxies</a>.<span title="=&gt; Int">length</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="comment">// double the size</span>
      <span class="keyword">val</span> <a title="Array[scales.xml.TreeProxy]" id="103341">ar</a> = <span title="object Array">Array</span>.<span title="[T](n1: Int)(implicit evidence$3: scala.reflect.ClassManifest[T])Array[T]">ofDim</span><span title="(n1: Int)(implicit evidence$3: scala.reflect.ClassManifest[scales.xml.TreeProxy])Array[scales.xml.TreeProxy]" class="delimiter">[</span><a href="#12780" title="scales.xml.TreeProxy">TreeProxy</a><span class="delimiter">]</span><span title="(clazz: java.lang.Class[_])scala.reflect.ClassManifest[scales.xml.TreeProxy]" class="delimiter">(</span> <a href="#91982" title="Array[scales.xml.TreeProxy]">_proxies</a>.<span title="=&gt; Int">length</span> <span title="(x: Int)Int">*</span> <span title="Int(2)" class="int">2</span> <span class="delimiter">)</span>
      <span title="object Array">Array</span>.<span title="(src: AnyRef, srcPos: Int, dest: AnyRef, destPos: Int, length: Int)Unit">copy</span><span class="delimiter">(</span><a href="#91982" title="Array[scales.xml.TreeProxy]">_proxies</a>, <span title="Int(0)" class="int">0</span>, <a href="#103341" title="Array[scales.xml.TreeProxy]">ar</a>, <span title="Int(0)" class="int">0</span>, <a href="#91982" title="Array[scales.xml.TreeProxy]">_proxies</a>.<span title="=&gt; Int">length</span><span class="delimiter">)</span>
      <a href="#91982" title="Array[scales.xml.TreeProxy]">_proxies</a> = <a href="#103341" title="Array[scales.xml.TreeProxy]">ar</a>
    <span class="delimiter">}</span>

    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#91981" title="Int">_depth</a> <span title="(x: Int)Boolean">==</span> <a href="#91983" title="Int">_size</a><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#91984" title="scales.xml.TreeProxy">_current</a> = <span title="scales.xml.TreeProxy" class="keyword">new</span> <a href="#12780" title="scales.xml.TreeProxy">TreeProxy</a><span class="delimiter">(</span><a href="#92002" title="scales.xml.Elem">elem</a>, <a href="#92003" title="=&gt; scales.xml.package.XmlBuilder">builder</a><span class="delimiter">)</span>
      <a href="#91982" title="(i: Int, x: scales.xml.TreeProxy)Unit">_proxies</a><span class="delimiter">(</span><a href="#91981" title="Int">_depth</a><span class="delimiter">)</span> = <a href="#91984" title="scales.xml.TreeProxy">_current</a>
      <a href="#91983" title="Int">_size</a> <span title="(x: Int)Int">+=</span><span title="Int(1)" class="int">1</span>
    <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
      <a href="#91984" title="scales.xml.TreeProxy">_current</a> = <a href="#91982" title="(i: Int)scales.xml.TreeProxy">_proxies</a><span class="delimiter">(</span><a href="#91981" title="Int">_depth</a><span class="delimiter">)</span>
      <a href="#91984" title="scales.xml.TreeProxy">_current</a>.<a href="#103146" title="(elem: scales.xml.Elem)Unit">setElem</a><span class="delimiter">(</span><a href="#92002" title="scales.xml.Elem">elem</a><span class="delimiter">)</span>
      <a href="#91984" title="scales.xml.TreeProxy">_current</a>.<a href="#103147" title="=&gt; scales.xml.package.XmlBuilder">builder</a>.<span title="()Unit">clear</span><span class="delimiter">(</span><span class="delimiter">)</span> <span class="comment">// don't create a new one</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Only call when its the end of the parse
   */</span> 
  <span class="keyword">def</span> <a title="=&gt; scales.xml.package.XmlTree" id="91996">tree</a> = 
    <a href="#91979" title="=&gt; scales.xml.package.XmlTree">rootTree</a>

<span class="delimiter">}</span>

        </pre>
    </body>
</html>